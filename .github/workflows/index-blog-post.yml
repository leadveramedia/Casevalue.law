# Google Indexing API workflow with Workload Identity Federation
# Triggered by Sanity CMS webhook via repository_dispatch
#
# This workflow uses keyless authentication (no service account JSON needed)
# via Google Cloud Workload Identity Federation with GitHub OIDC.

name: Index Blog Post

on:
  repository_dispatch:
    types: [index-blog-post]

permissions:
  contents: read
  id-token: write  # Required for OIDC token request

jobs:
  index:
    runs-on: ubuntu-latest
    steps:
      - name: Validate payload
        env:
          SLUG: ${{ github.event.client_payload.slug }}
          ACTION: ${{ github.event.client_payload.action }}
        run: |
          if [ -z "$SLUG" ]; then
            echo "Error: No slug provided in payload"
            exit 1
          fi
          # Validate slug format (lowercase alphanumeric + hyphens only)
          if ! echo "$SLUG" | grep -qE '^[a-z0-9-]+$'; then
            echo "Error: Invalid slug format"
            exit 1
          fi
          echo "Processing blog post: $SLUG"
          echo "Action type: $ACTION"

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2.1.13
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'
          access_token_scopes: 'https://www.googleapis.com/auth/indexing'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f # v2.2.1

      - name: Submit URL to Google Indexing API
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          SLUG: ${{ github.event.client_payload.slug }}
          ACTION: ${{ github.event.client_payload.action }}
        run: |
          URL="https://casevalue.law/blog/${SLUG}"

          # Determine notification type
          if [ "$ACTION" = "delete" ]; then
            TYPE="URL_DELETED"
          else
            TYPE="URL_UPDATED"
          fi

          echo "Submitting to Google Indexing API:"
          echo "  URL: ${URL}"
          echo "  Type: ${TYPE}"

          # Call Google Indexing API using access token with indexing scope
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://indexing.googleapis.com/v3/urlNotifications:publish" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"url\": \"${URL}\",
              \"type\": \"${TYPE}\"
            }")

          # Parse response
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response (HTTP ${HTTP_CODE}):"
          echo "$BODY" | jq . 2>/dev/null || echo "$BODY"

          # Check for success
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Successfully submitted URL for indexing!"
          else
            echo "Error: Failed to submit URL"
            exit 1
          fi

      - name: Summary
        env:
          SLUG: ${{ github.event.client_payload.slug }}
          ACTION: ${{ github.event.client_payload.action }}
        run: |
          echo "## Blog Post Indexed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://casevalue.law/blog/${SLUG}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${ACTION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
