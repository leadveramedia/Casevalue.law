# Netlify Configuration File
# Learn more: https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  publish = "build"
  command = "npm run build"

# ============================================================================
# PRERENDERING CONFIGURATION
# ============================================================================
# Prerendering is enabled in Netlify UI for all React SPA pages
# including /blog/* routes (blog is rendered by React, content from Sanity CMS)
# - Prerendering generates static HTML for search engine crawlers
# - React hydrates the page for interactivity
# ============================================================================

# Headers for better security and caching
[[headers]]
  for = "/*"
  [headers.values]
    # X-Frame-Options removed — using CSP frame-ancestors instead (can be overridden per-path for /embed)
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    # HSTS - Force HTTPS for all requests
    Strict-Transport-Security = "max-age=31536000; includeSubDomains"
    # Content Security Policy - controls which resources can be loaded
    # - 'self': same origin
    # - 'unsafe-inline': needed for Tailwind CSS and inline styles
    # - googletagmanager.com: Google Tag Manager
    # - google-analytics.com: Google Analytics
    # - cdn.sanity.io: Sanity CMS images
    # - images.unsplash.com: Stock images
    # - clarity.ms: Microsoft Clarity analytics
    # CSP updated to allow:
    # - PPC tracking: Google Ads, Facebook, Bing, LinkedIn
    # - Google Tag Manager (including preview mode)
    # - Microsoft Clarity analytics
    # - Google Fonts
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://tagmanager.google.com https://www.google-analytics.com https://www.clarity.ms https://scripts.clarity.ms https://connect.facebook.net https://bat.bing.com https://snap.licdn.com https://www.googleadservices.com https://googleads.g.doubleclick.net; style-src 'self' 'unsafe-inline' https://tagmanager.google.com https://fonts.googleapis.com; img-src 'self' data: https://cdn.sanity.io https://images.unsplash.com https://www.google-analytics.com https://www.googletagmanager.com https://www.google.com https://www.facebook.com https://bat.bing.com https://c.bing.com https://px.ads.linkedin.com https://ssl.gstatic.com https://www.gstatic.com https://c.clarity.ms; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.sanity.io https://www.google-analytics.com https://analytics.google.com https://www.google.com https://www.clarity.ms https://*.clarity.ms https://*.nsvcs.net https://region1.google-analytics.com https://connect.facebook.net https://www.facebook.com https://bat.bing.com https://px.ads.linkedin.com https://www.googleadservices.com https://googleads.g.doubleclick.net https://stats.g.doubleclick.net; frame-src 'self' https://www.googletagmanager.com; frame-ancestors 'none'; object-src 'none'; base-uri 'self'; form-action 'self' https://api.netlify.com;"

# ============================================================================
# EMBED WIDGET HEADERS
# ============================================================================
# Allow iframe embedding for the /embed route.
# Global CSP has frame-ancestors 'none'; this overrides it with frame-ancestors * for embeds.
[[headers]]
  for = "/embed"
  [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://cdn.sanity.io https://images.unsplash.com; font-src 'self'; connect-src 'self' https://*.sanity.io; frame-ancestors *; object-src 'none'; base-uri 'self'; form-action 'self' https://api.netlify.com;"
    Cache-Control = "public, max-age=0, must-revalidate"

# Cache static assets for better performance
[[headers]]
  for = "/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache images
[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Prevent caching of index.html to ensure fresh deploys work immediately
# Using public + max-age=0 (not no-store) so Netlify prerender extension can cache rendered HTML
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Also prevent caching of root path (serves index.html)
[[headers]]
  for = "/"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# ============================================================================
# BLOG HEADERS
# ============================================================================
# Blog is rendered by React SPA, content fetched from Sanity CMS.
# No caching so crawlers always get fresh content via Netlify prerendering.
[[headers]]
  for = "/blog"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/blog/*"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# ============================================================================
# CALCULATOR HEADERS
# ============================================================================
# Practice area calculator pages (/calculator/:slug) are React SPA routes.
# No caching so crawlers always get fresh content via Netlify prerendering.
[[headers]]
  for = "/calculator/*"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# ============================================================================
# 404 HANDLING
# ============================================================================
# Static 404.html is served with proper 404 status code for missing files
# React Router handles in-app 404s (e.g., /blog/invalid-slug)
# The _redirects file provides SPA fallback with Status 200 (rewrite, not redirect)
#
# How it works:
# 1. Server-level 404s (missing files) → public/404.html with 404 status
# 2. In-app 404s (invalid routes) → NotFoundPage component via React Router
# 3. Valid routes → index.html → React app hydrates
#
# Testing 404 handling:
# 1. Test missing file: https://casevalue.law/nonexistent.jpg (should show 404.html)
# 2. Test invalid route: https://casevalue.law/invalid-page (should show NotFoundPage)
# 3. Test invalid blog post: https://casevalue.law/blog/invalid-slug (should show NotFoundPage)
# ============================================================================

# ============================================================================
# PLUGINS
# ============================================================================
# IndexNow: Submits all URLs to Bing/Yandex after every successful deploy
[[plugins]]
  package = "./netlify-plugins/indexnow"

# ============================================================================
# REDIRECTS
# ============================================================================
# Redirects in public/_redirects file:
# - Dynamic sitemap (/sitemap.xml -> Netlify Function)
# - SPA fallback (/* -> /index.html)
